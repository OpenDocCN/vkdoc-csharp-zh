# 七、添加平面检测和点云

现在我们要将生成的平面添加到我们的游戏中，这将有助于 ARKit 相机跟踪设备的移动。

## 创建生成的平面游戏对象

就像我们在第 3 章中所做的一样，创建一个空的游戏对象。从文件菜单中，选择游戏对象➤空白(图 [7-1](#Fig1) )。

![img/460089_1_En_7_Chapter/460089_1_En_7_Fig1_HTML.jpg](img/460089_1_En_7_Chapter/460089_1_En_7_Fig1_HTML.jpg)

图 7-1

创建一个空的游戏对象

选择游戏对象，在检查器中，命名这个创建的平面(图 [7-2](#Fig2) )。

![img/460089_1_En_7_Chapter/460089_1_En_7_Fig2_HTML.jpg](img/460089_1_En_7_Chapter/460089_1_En_7_Fig2_HTML.jpg)

图 7-2

命名游戏对象创建的平面

现在我们需要添加一个组件。在创建的平面检查器中选择添加组件按钮；并在搜索栏中搜索 Unity AR 生成的平面脚本(图 [7-3](#Fig3) )。

![img/460089_1_En_7_Chapter/460089_1_En_7_Fig3_HTML.jpg](img/460089_1_En_7_Chapter/460089_1_En_7_Fig3_HTML.jpg)

图 7-3

搜索 Unity AR 生成的平面脚本

在 Unity AR 生成的平面脚本包含在 Created Planes 游戏对象中的情况下，在 Unity AR 生成的平面脚本的 Plane Prefab 设置中，选择选项框右侧的小齿轮，搜索并选择 DebugPlanePrefab(图 [7-4](#Fig4) )。

![img/460089_1_En_7_Chapter/460089_1_En_7_Fig4_HTML.jpg](img/460089_1_En_7_Chapter/460089_1_En_7_Fig4_HTML.jpg)

图 7-4

搜索调试计划预设

### 创建点云游戏对象

创建一个空的游戏对象(图 [7-5](#Fig5) )。在检查器中选择空的游戏对象，将其重命名为点云。现在添加一个组件。在搜索栏中，搜索 Unity 点云粒子实例，并将其添加到点云游戏对象中(图 [7-6](#Fig6) )。

![img/460089_1_En_7_Chapter/460089_1_En_7_Fig6_HTML.jpg](img/460089_1_En_7_Chapter/460089_1_En_7_Fig6_HTML.jpg)

图 7-6

搜索点云粒子示例

![img/460089_1_En_7_Chapter/460089_1_En_7_Fig5_HTML.jpg](img/460089_1_En_7_Chapter/460089_1_En_7_Fig5_HTML.jpg)

图 7-5

创建一个空的游戏对象

添加了 Unity 点云粒子示例脚本后，现在将最大点数设置为 120(图 [7-7](#Fig7) )。您可以设置任意多的点云。

![img/460089_1_En_7_Chapter/460089_1_En_7_Fig7_HTML.jpg](img/460089_1_En_7_Chapter/460089_1_En_7_Fig7_HTML.jpg)

图 7-7

设置要显示的最大点数

现在添加一个点云粒子预设到点云预设属性框。选择点云预设属性框右边的小齿轮，然后搜索点云预设(图 [7-8](#Fig8) )。在点云粒子示例脚本中，选择点云预设并将其拖动到点云粒子预设框中(图 [7-9](#Fig9) )。

![img/460089_1_En_7_Chapter/460089_1_En_7_Fig9_HTML.jpg](img/460089_1_En_7_Chapter/460089_1_En_7_Fig9_HTML.jpg)

图 7-9

设置为点云预设的点云预设

![img/460089_1_En_7_Chapter/460089_1_En_7_Fig8_HTML.jpg](img/460089_1_En_7_Chapter/460089_1_En_7_Fig8_HTML.jpg)

图 7-8

搜索点云预置

### 设置主摄像机

你可能还记得在第 3 章中，我们需要为 AR 设置游戏。我们需要做的第一件事是改变主摄像头的设置。如果你记得如何做，你可以跳过这一节。然而，我将为那些不久前读过第三章[的读者提供一个设置指南，他们可能需要我们如何设置的提示，](3.html)

在层次结构中，选择主摄像机，并在检查器中，将清除标志设置为仅深度(图 [7-10](#Fig10) )。

![img/460089_1_En_7_Chapter/460089_1_En_7_Fig10_HTML.jpg](img/460089_1_En_7_Chapter/460089_1_En_7_Fig10_HTML.jpg)

图 7-10

仅将清除标志设置为深度

选择主摄像机后，在检查器中选择“添加组件”。现在搜索并添加 Unity AR 视频脚本(图 [7-11](#Fig11) )。

![img/460089_1_En_7_Chapter/460089_1_En_7_Fig11_HTML.jpg](img/460089_1_En_7_Chapter/460089_1_En_7_Fig11_HTML.jpg)

图 7-11

搜索 Unity AR 视频脚本组件

现在选择 Unity AR 视频脚本(单击鼠标左键)，该组件应添加到主摄像机中(图 [7-12](#Fig12) )。

![img/460089_1_En_7_Chapter/460089_1_En_7_Fig12_HTML.jpg](img/460089_1_En_7_Chapter/460089_1_En_7_Fig12_HTML.jpg)

图 7-12

添加到主摄像机的 Unity AR 视频脚本组件

### 设置 Unity AR 视频脚本清除素材

在 Unity AR 视频脚本组件的属性框右侧，有一个小齿轮(图[7-12](#Fig12))；选择该档位，搜索 YUV 材质(图 [7-13](#Fig13) )。

![img/460089_1_En_7_Chapter/460089_1_En_7_Fig13_HTML.jpg](img/460089_1_En_7_Chapter/460089_1_En_7_Fig13_HTML.jpg)

图 7-13

为透明材质选择 YUV 材质

#### 添加 Unity AR 摄像机管理器

在主摄像机仍然被选中的情况下，在检查器中选择添加组件(图[7-14](#Fig14))；现在搜索 AR 相机管理器(图 [7-15](#Fig15) ，现在将其添加到主相机中。

![img/460089_1_En_7_Chapter/460089_1_En_7_Fig15_HTML.jpg](img/460089_1_En_7_Chapter/460089_1_En_7_Fig15_HTML.jpg)

图 7-15

搜索 Unity AR 相机跟踪器

![img/460089_1_En_7_Chapter/460089_1_En_7_Fig14_HTML.jpg](img/460089_1_En_7_Chapter/460089_1_En_7_Fig14_HTML.jpg)

图 7-14

添加组件

现在添加主摄像机作为跟踪摄像机。要将主摄像机添加到 Unity AR 摄像机管理器的摄像机属性中，请从层级中选择主摄像机，并将其拖动到 Unity AR 摄像机管理器的跟踪摄像机属性中(图 [7-16](#Fig16) )。

![img/460089_1_En_7_Chapter/460089_1_En_7_Fig16_HTML.jpg](img/460089_1_En_7_Chapter/460089_1_En_7_Fig16_HTML.jpg)

图 7-16

将主摄像机设置为跟踪摄像机

#### 添加 Unity 远程连接

为了在游戏选项卡中测试我们的游戏，我们还需要将 Unity Remote 连接添加到我们的层次结构中。在项目选项卡中，搜索名为 ARKitRemoteConnection 的预置(图 [7-17](#Fig17) )。

![img/460089_1_En_7_Chapter/460089_1_En_7_Fig17_HTML.jpg](img/460089_1_En_7_Chapter/460089_1_En_7_Fig17_HTML.jpg)

图 7-17

搜索 UnityARKitRemoteConnection 预置

选择这个预设，并将其添加到场景中(将其拖动到层次中)(图 [7-18](#Fig18) )。

![img/460089_1_En_7_Chapter/460089_1_En_7_Fig18_HTML.jpg](img/460089_1_En_7_Chapter/460089_1_En_7_Fig18_HTML.jpg)

图 7-18

场景中的 UnityARKitRemoteConnection

现在我们需要在我们的 iOS 设备上打开 ARKitRemote。首先，将您的 iOS 设备连接到您的开发电脑。在 Unity 中，选择游戏选项卡，然后按播放按钮。Unity 会在控制台菜单中提示你连接播放器(图 [7-19](#Fig19) )。

![img/460089_1_En_7_Chapter/460089_1_En_7_Fig19_HTML.jpg](img/460089_1_En_7_Chapter/460089_1_En_7_Fig19_HTML.jpg)

图 7-19

Unity 连接到玩家消息

在控制台表中，选择编辑器并选择您的 iOS 设备(图 [7-20](#Fig20) )。

![img/460089_1_En_7_Chapter/460089_1_En_7_Fig20_HTML.jpg](img/460089_1_En_7_Chapter/460089_1_En_7_Fig20_HTML.jpg)

图 7-20

在控制台菜单中选择 iOS 设备

然后 Unity 会提示你启动远程 ARKit 会话(图 [7-21](#Fig21) )。在 Unity 中点击游戏屏幕上的图标，您的应用现在可以在您的 iOS 设备上运行。

![img/460089_1_En_7_Chapter/460089_1_En_7_Fig21_HTML.jpg](img/460089_1_En_7_Chapter/460089_1_En_7_Fig21_HTML.jpg)

图 7-21

启动远程 ARKit 会话提示

在图 [7-22](#Fig22) 中，你可以看到我已经成功地在我的 iPhone 上查看了 Hello WorldAR 应用，并看到了 Unity 中的场景。如果您移动您的设备，您应该在 Unity 场景选项卡中看到摄像机移动，在游戏选项卡中看到画面变化。我想指出的是，这会有点慢(滞后)，但 ARKitRemote 是目前测试 iOS 版 Unity AR 开发的最佳方式。

![img/460089_1_En_7_Chapter/460089_1_En_7_Fig22_HTML.jpg](img/460089_1_En_7_Chapter/460089_1_En_7_Fig22_HTML.jpg)

图 7-22

游戏视图

#### 休斯顿，我们有一个问题…

如果你得到的结果和我在图 [7-23](#Fig23) 中得到的结果相似，不要惊慌！场景正在实时渲染。保龄球和保龄球瓶被渲染，虚拟操纵杆也被渲染。我们可以看到点云。但是…窗格(t)仍然可见。

![img/460089_1_En_7_Chapter/460089_1_En_7_Fig23_HTML.jpg](img/460089_1_En_7_Chapter/460089_1_En_7_Fig23_HTML.jpg)

图 7-23

取消选择网格渲染器

为了解决这个问题，我们将禁用平面(t)的网格渲染器组件。为此，在层次中，选择平面(t)游戏对象，并在检查器中，取消选择网格渲染器(图 [7-24](#Fig24) )。为此，用鼠标左键单击网格渲染器组件左侧复选框中的复选标记。

现在重新测试你的构建，看看结果。你的结果应该和我差不多(图 [7-24](#Fig24) )。

![img/460089_1_En_7_Chapter/460089_1_En_7_Fig24_HTML.jpg](img/460089_1_En_7_Chapter/460089_1_En_7_Fig24_HTML.jpg)

图 7-24

没有飞机的游戏视图(t)

#### 在 iOS 设备上测试

由于我们已经成功地在游戏视图中测试了当前版本，现在是时候看看这是否能在我们的设备上运行了。

从主菜单中选择文件➤构建设置(图 [7-25](#Fig25) )。确保您已经选择了 iOS 作为平台，并且选中了 Development Build 复选框。此外，一定要检查你是否构建了正确的场景(图 [7-26](#Fig26) )。在“构件设置”菜单中，选择“播放器设置”,并在检查器中确定其他设置选项设置正确。我已将我的版本设置为 3.0 版。然而，您可能想要使用不同的版本号(图 [7-27](#Fig27) )。

![img/460089_1_En_7_Chapter/460089_1_En_7_Fig27_HTML.jpg](img/460089_1_En_7_Chapter/460089_1_En_7_Fig27_HTML.jpg)

图 7-27

其他设置菜单选项

![img/460089_1_En_7_Chapter/460089_1_En_7_Fig26_HTML.jpg](img/460089_1_En_7_Chapter/460089_1_En_7_Fig26_HTML.jpg)

图 7-26

构件设置菜单

![img/460089_1_En_7_Chapter/460089_1_En_7_Fig25_HTML.jpg](img/460089_1_En_7_Chapter/460089_1_En_7_Fig25_HTML.jpg)

图 7-25

选择构建设置

从“生成设置”菜单中，选择“生成并运行”。Unity 会编译代码，然后打开 Xcode。确定您的 iOS 设备已连接，并且您已在 Xcode 中正确设定了预置描述文件。如果一切设置正确，Xcode 会将您的游戏部署到您的 iOS 设备上，您可以测试构建。

#### 为原力带来平衡

当我们在游戏视图中测试我们的游戏时，我们发现保龄球游戏对象可能有点太快了。如果你能够在你的 iOS 设备上测试这个游戏，你可能会觉得我们也有类似的情况。让一个游戏变得公平或平衡的过程并不容易；这需要大量的计划和测试。在我们的游戏中，我们将保龄球游戏对象设置为 5 米/小时。正如你可能想象的那样，普通的保龄球手不太可能以 5 米/小时的速度投球。然而，由于这是一个游戏，我们有一些自由和创作许可。但是，我们不想让游戏太难或太容易。找到这种平衡很有挑战性。像所有伟大的烹饪节目一样，我将测试设置并报告结果。然而，如果你想尝试测试保龄球的不同速度，这将是一个很好的体验。然而，我建议在游戏视图中测试游戏，不要在你的 iOS 设备上部署这个版本。

#### 减慢保龄球的速度

有两种方法可以让保龄球慢下来。我们可以增加它的质量(使它更重)或者我们可以减慢它的移动速度。我倾向于第二种选择。在层次中，选择保龄球游戏对象，并在检查器中将玩家示例组件中的移动速度设置为 0.5(图 [7-28](#Fig28) )。

![img/460089_1_En_7_Chapter/460089_1_En_7_Fig28_HTML.jpg](img/460089_1_En_7_Chapter/460089_1_En_7_Fig28_HTML.jpg)

图 7-28

调整后的移动速度设置

我对这个设置相当满意，但是一些用户测试将帮助我们确认这个速度是否太慢。

### 照明设备

就像我们在第 4 章中所做的一样，我们将调整我们的灯光，使游戏中的灯光更接近真实世界的灯光。

#### 关灯

我们将为我们的应用使用不同的光源。然而，为了获得最佳效果，让我们确保已经关闭了场景中的所有灯光。

从主菜单中选择窗口➤照明➤设置(图 [7-29](#Fig29) )。

![img/460089_1_En_7_Chapter/460089_1_En_7_Fig29_HTML.jpg](img/460089_1_En_7_Chapter/460089_1_En_7_Fig29_HTML.jpg)

图 7-29

选择照明设置

在“照明设置”的“环境设置”中，将“强度倍增”更改为零。在混合照明设置中，取消烘焙照明设置(图 [7-30](#Fig30) )。

![img/460089_1_En_7_Chapter/460089_1_En_7_Fig30_HTML.jpg](img/460089_1_En_7_Chapter/460089_1_En_7_Fig30_HTML.jpg)

图 7-30

更改照明设置

现在选择平行光，在检查器中，改变颜色为白色。并在属性框中输入所需颜色的 RGB 或 HSV 值(图 [7-31](#Fig31) )。

![img/460089_1_En_7_Chapter/460089_1_En_7_Fig31_HTML.jpg](img/460089_1_En_7_Chapter/460089_1_En_7_Fig31_HTML.jpg)

图 7-31

键入颜色属性

#### 设置环境光源

现在我们可以设置环境光源。选择方向灯，选择添加组件按钮并搜索环境(图 [7-32](#Fig32) )。

![img/460089_1_En_7_Chapter/460089_1_En_7_Fig32_HTML.jpg](img/460089_1_En_7_Chapter/460089_1_En_7_Fig32_HTML.jpg)

图 7-32

搜索 Unity AR 环境

你会看到 Unity ARKit 还包含了一个名为 Unity AR Ambient 的脚本。选择这个脚本将其添加到我们的平行光中(图 [7-33](#Fig33) )。

![img/460089_1_En_7_Chapter/460089_1_En_7_Fig33_HTML.jpg](img/460089_1_En_7_Chapter/460089_1_En_7_Fig33_HTML.jpg)

图 7-33

添加到平行光的 Unity AR 环境脚本

#### 摘要

在这一章中，我们在游戏中添加了平面探测和点云。我们还改进了照明，使游戏中的照明看起来更接近真实世界中的照明。在我们的下一章中，我们将会看到给我们的游戏添加声音。

阅读本章的更有经验的开发者可能会意识到我们在游戏中仍然有 Plane(t) GameObject。如果我们完全移除平面(t)游戏对象，保龄球和保龄球瓶将继续下落。这是因为这些游戏对象是在创建的平面之前实例化的。在第 8 章中，我们将介绍如何在创建的平面创建后在 Unity 中实例化这些游戏对象。目前，我们有一个相当可靠的测试环境。