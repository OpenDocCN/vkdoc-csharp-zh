# 四、命中测试和照明

在上一章中，我们使用了云点和生成的平面来帮助相机跟踪设备的移动。然而，你可能已经注意到，我们惊人的立方体继续停留在原点。虽然这对于我们的第一个 AR 应用程序来说可能没什么问题，但我敢肯定，随着时间的推移，你可能会想要创建看起来位于现实世界中的物理对象上的虚拟对象。为了做到这一点，我们将使用 Unity ARKit 的一个名为 hit testing 的特性。你可能也注意到了，你的 iOS 设备屏幕上的 GameObject 的光照与现实世界中的光照并不一致；我们也将在本章中讨论这个问题。

## 点击测试

点击测试将使我们能够在我们在第 [3](3.html) 章创建的生成平面上放置一些东西。这也将使 AR 应用程序能够将对象放置在真实世界中的某个位置，该位置与用户在设备屏幕上点击的位置相关。

让我们打开我们在上一章创建的 Hello WorldAR 场景。随着你好世界 AR 场景在 Unity 中打开，现在在层级中选择创建的飞机游戏对象(图 [4-1](#Fig1) )。

![img/460089_1_En_4_Chapter/460089_1_En_4_Fig1_HTML.jpg](img/460089_1_En_4_Chapter/460089_1_En_4_Fig1_HTML.jpg)

图 4-1

在层级中选择创建的平面游戏对象

在层级中选择创建的平面游戏对象，选择添加组件；并在搜索栏中搜索编辑器点击测试(图 [4-2](#Fig2) )。现在选择它来添加到我们创建的飞机游戏对象中。该脚本将使我们能够在编辑器中测试点击测试的基本功能。

![img/460089_1_En_4_Chapter/460089_1_En_4_Fig2_HTML.jpg](img/460089_1_En_4_Chapter/460089_1_En_4_Fig2_HTML.jpg)

图 4-2

搜索编辑器点击测试

到现在为止，你可能很想在 AR 应用中加入一些比我们的立方体更有趣的东西。我们可以在资产库中搜索感兴趣的或相关的资产，或者我们可以创建自己的资产。由于制作我们自己的游戏资产非常耗时，超出了本书的范围，现在，让我们使用 Unity ARKit 中现有的资产之一。在项目文件夹中搜索资产播放器(图 [4-3](#Fig3) )。如果你下载的 Unity ARKit 版本中没有这个 GameObject，可以从 Unity Asset Store([https://Asset Store)下载。Unity。com/packages/essentials/tutorial-projects/survival-shooter-tutorial-40756](https://assetstore.unity.com/packages/essentials/tutorial-projects/survival-shooter-tutorial-40756))。

![img/460089_1_En_4_Chapter/460089_1_En_4_Fig3_HTML.jpg](img/460089_1_En_4_Chapter/460089_1_En_4_Fig3_HTML.jpg)

图 4-3

搜索玩家游戏资产

选中该资产，将其拖至层级(图 [4-4](#Fig4) )。

![img/460089_1_En_4_Chapter/460089_1_En_4_Fig4_HTML.jpg](img/460089_1_En_4_Chapter/460089_1_En_4_Fig4_HTML.jpg)

图 4-4

添加到层级中的玩家角色

现在是时候和我们神奇的立方体说再见了。在层次中选择立方体，右键单击并选择删除(图 [4-5](#Fig5) )。

![img/460089_1_En_4_Chapter/460089_1_En_4_Fig5_HTML.jpg](img/460089_1_En_4_Chapter/460089_1_En_4_Fig5_HTML.jpg)

图 4-5

删除多维数据集

### 规模

你可能还记得，在第 2 章中，我讨论了规模在 AR 中的重要性。如果你在层级中选择玩家游戏对象，你会看到这个资产有 1 米高。这可能没问题，但我想让这个资产在现实世界中看起来小很多。我怀疑这是创建该资产的人的意图。选中玩家游戏对象，将比例改为 0.25，. 25，. 25(图 [4-6](#Fig6) )。

![img/460089_1_En_4_Chapter/460089_1_En_4_Fig6_HTML.jpg](img/460089_1_En_4_Chapter/460089_1_En_4_Fig6_HTML.jpg)

图 4-6

重新缩放的玩家游戏对象

### 转换

如果你选择了主摄像头并查看摄像头预览窗口，你会注意到我们的玩家游戏对象对玩家是不可见的。如果您查看检查器或主摄像机和玩家游戏对象，您会看到这两个资源的位置都是 0，0，0。让我们移动玩家游戏对象。选择玩家，游戏对象，在检查器中改变位置到 0，0，1(图 [4-7](#Fig7) )。

![img/460089_1_En_4_Chapter/460089_1_En_4_Fig7_HTML.jpg](img/460089_1_En_4_Chapter/460089_1_En_4_Fig7_HTML.jpg)

图 4-7

玩家游戏对象重新定位

你会注意到在图 [4-7](#Fig7) 中，玩家游戏对象正背对着摄像机。我认为如果玩家游戏对象面向玩家会更好。选择玩家游戏对象，使用旋转工具，在 Y 轴旋转玩家游戏对象，直到它面对主摄像机(图 [4-8](#Fig8) )。

![img/460089_1_En_4_Chapter/460089_1_En_4_Fig8_HTML.jpg](img/460089_1_En_4_Chapter/460089_1_En_4_Fig8_HTML.jpg)

图 4-8

旋转玩家游戏对象

当旋转游戏对象时，也有可能无意中改变另一个轴。在图 [4-8](#Fig8) 中，注意 X 轴和 Y 轴的变换位置也发生了变化。让我们将 X 轴的位置重置为 0，将 Z 轴的位置重置为 1。我更喜欢整数，所以我将 Y 轴的旋转设置为 156(图 [4-9](#Fig9) )。

![img/460089_1_En_4_Chapter/460089_1_En_4_Fig9_HTML.jpg](img/460089_1_En_4_Chapter/460089_1_En_4_Fig9_HTML.jpg)

图 4-9

旋转的玩家游戏对象

### 编辑点击测试脚本

现在选择创建的飞机游戏对象中的编辑器点击测试脚本。编辑器点击测试脚本有三个可变参数:点击变换、最大光线距离和碰撞层遮罩(图 [4-10](#Fig10) )。

![img/460089_1_En_4_Chapter/460089_1_En_4_Fig10_HTML.jpg](img/460089_1_En_4_Chapter/460089_1_En_4_Fig10_HTML.jpg)

图 4-10

编辑器点击测试脚本

#### 点击变换

点击变换参数框指定游戏对象的变换。在我们的例子中，这将是我们的玩家游戏对象的 x，y，z，它将被移动到玩家选择的位置。编辑器点击测试脚本目前不支持点击或触摸，因此在这种情况下，游戏对象将被放置在玩家在 Unity 编辑器的游戏标签中点击的位置。

在层级中选择玩家游戏对象，并将其拖至点击编辑器测试脚本中的点击变换属性框(图 [4-11](#Fig11) )。

![img/460089_1_En_4_Chapter/460089_1_En_4_Fig11_HTML.jpg](img/460089_1_En_4_Chapter/460089_1_En_4_Fig11_HTML.jpg)

图 4-11

点击转换属性中的玩家游戏对象转换集

#### 最大光线距离

在本练习中，我们不会更改最大光线距离。如果您有兴趣了解这个参数，互联网上有大量关于光线投射的信息。简而言之，这是一个投射不可见光线来检测光线路径上是否有任何东西(如对撞机)的过程。

#### 碰撞层遮罩

碰撞层遮罩下拉菜单有几个选项(图 [4-12](#Fig12) )。

![img/460089_1_En_4_Chapter/460089_1_En_4_Fig12_HTML.jpg](img/460089_1_En_4_Chapter/460089_1_En_4_Fig12_HTML.jpg)

图 4-12

碰撞层遮罩选项

我们将选择 ARKitPlane 选项。“碰撞层遮罩”选项设置在碰撞测试期间要考虑的碰撞层遮罩。在我们的例子中，我们将选择 ARKitPlane。

#### 测试

现在将您的 iOS 设备连接到 Mac，并在您的设备上运行 UnityARKitRemote 应用程序。在 Unity 的控制台中，从编辑器中选择您的设备，然后按播放按钮。在游戏屏幕中，单击开始 ARKitRemote 图标，然后慢慢移动设备，以便相机找到合适的平面。当你在 Unity 的游戏选项卡中看到一个平面时，在那个平面内点击，你将在游戏视图屏幕中看到你的玩家头像(图 [4-13](#Fig13) )。

![img/460089_1_En_4_Chapter/460089_1_En_4_Fig13_HTML.jpg](img/460089_1_En_4_Chapter/460089_1_En_4_Fig13_HTML.jpg)

图 4-13

游戏视图屏幕中的玩家游戏对象

#### 在我们的设备上测试

现在我们已经成功地在编辑器中测试了我们的 AR 应用程序，是时候看看它在我们的设备上是什么样子了。您可能还记得，在我们的测试构建期间，我们添加了编辑器点击测试脚本。这个脚本对于在编辑器中测试我们的应用程序非常有用，但是我们发现，它不支持我们设备上的点击或触摸用户交互。如果我们想在我们的设备上测试应用程序，有一个更好的选择。

#### 移除组件

要从创建的平面游戏对象中移除编辑器点击测试脚本组件，我们需要选择右边的档位(图 [4-14](#Fig14) )。选择移除组件选项。

![img/460089_1_En_4_Chapter/460089_1_En_4_Fig14_HTML.jpg](img/460089_1_En_4_Chapter/460089_1_En_4_Fig14_HTML.jpg)

图 4-14

移除组件菜单选项

#### 添加组件

现在让我们添加一个组件，它将在我们的设备上支持全功能的用户交互。在我们创建的飞机游戏对象的检查器中，选择添加组件按钮，并在搜索栏中搜索 hit(图 [4-15](#Fig15) )。现在选择 Unity AR 点击测试示例脚本，将其添加到我们创建的平面游戏对象(4-16)中。

![img/460089_1_En_4_Chapter/460089_1_En_4_Fig16_HTML.jpg](img/460089_1_En_4_Chapter/460089_1_En_4_Fig16_HTML.jpg)

图 4-16

Unity AR 点击测试示例脚本添加到生成的飞机游戏对象

![img/460089_1_En_4_Chapter/460089_1_En_4_Fig15_HTML.jpg](img/460089_1_En_4_Chapter/460089_1_En_4_Fig15_HTML.jpg)

图 4-15

搜索 Unity AR 点击测试示例

#### 添加点击转换

正如我们对编辑器点击测试示例所做的那样，我们需要添加点击转换参数。为此，选择玩家游戏对象并将其拖至 Unity AR 套件测试示例中的点击变换属性框(图 [4-17](#Fig17) )。如果 ArKitPlane 未设置为碰撞层，请使用下拉菜单将其更改为 ARKitPlane。

![img/460089_1_En_4_Chapter/460089_1_En_4_Fig17_HTML.jpg](img/460089_1_En_4_Chapter/460089_1_En_4_Fig17_HTML.jpg)

图 4-17

添加到点击变换属性的播放器变换

#### 准备部署

在构建和运行我们的新应用程序之前，我们需要更改构建设置。从菜单中选择文件➤构建设置(图 [4-18](#Fig18) )。

![img/460089_1_En_4_Chapter/460089_1_En_4_Fig18_HTML.jpg](img/460089_1_En_4_Chapter/460089_1_En_4_Fig18_HTML.jpg)

图 4-18

选择构建设置

#### 更改生成设置

在构建设置菜单中，检查你正在构建场景选项中的当前场景(Hello WorldAR)(图 [4-19](#Fig19) )。

![img/460089_1_En_4_Chapter/460089_1_En_4_Fig19_HTML.jpg](img/460089_1_En_4_Chapter/460089_1_En_4_Fig19_HTML.jpg)

图 4-19

选择要构建的场景选项

选择播放器设置，并在检查器中更改产品名称和捆绑包标识符(图 [4-20](#Fig20) )。

![img/460089_1_En_4_Chapter/460089_1_En_4_Fig20_HTML.jpg](img/460089_1_En_4_Chapter/460089_1_En_4_Fig20_HTML.jpg)

图 4-20

播放器设置检查器

在我们选择构建和运行之前，我建议首先打开 Xcode，并确保我们已经选择了目标设备，并在签名菜单中设置了团队(图 [4-21](#Fig21) )。如果您现在不选择此项，您将会看到一条构建失败的消息。现在在构建设置菜单中。选择构建并运行。

![img/460089_1_En_4_Chapter/460089_1_En_4_Fig21_HTML.jpg](img/460089_1_En_4_Chapter/460089_1_En_4_Fig21_HTML.jpg)

图 4-21

Xcode 菜单签名团队选择框

在您成功构建应用程序并将其部署到您的 iOS 设备后，您应该能够运行该应用程序；当你点击设备上的屏幕时，你应该会看到你屏幕上的玩家游戏对象被放置在现实世界中的一个位置，这个位置与你点击屏幕的位置相关(图 [4-22](#Fig22) )。

![img/460089_1_En_4_Chapter/460089_1_En_4_Fig22_HTML.jpg](img/460089_1_En_4_Chapter/460089_1_En_4_Fig22_HTML.jpg)

图 4-22

部署在 iPhone 上的 Hello WorldAR 应用程序

虽然我们的玩家游戏对象比我们的立方体有趣得多，但我们可以改进这个应用程序。如果我们观察玩家游戏对象的光照，光照与现实世界中的光照并不完全一致。我们将改变 AR 图像的照明，使其更接近真实世界中的照明。我的孩子认为我们应该将我们的玩家游戏对象重命名为梦魇追逐者，所以我们也将我们的玩家游戏对象重命名为梦魇追逐者。

#### 更改玩家游戏对象名称

更改玩家游戏对象名称可以通过在层级中选择这个游戏对象，然后在检查器中选择当前名称并键入我们的新名称来完成(图 [4-23](#Fig23) )。另一个选项是右击层级中的玩家游戏对象，从下拉菜单中选择重命名选项(图 [4-24](#Fig24) )。

![img/460089_1_En_4_Chapter/460089_1_En_4_Fig24_HTML.jpg](img/460089_1_En_4_Chapter/460089_1_En_4_Fig24_HTML.jpg)

图 4-24

改变层级中玩家游戏对象的名称

![img/460089_1_En_4_Chapter/460089_1_En_4_Fig23_HTML.jpg](img/460089_1_En_4_Chapter/460089_1_En_4_Fig23_HTML.jpg)

图 4-23

在检查器中更改玩家游戏对象的名称

### 照明设备

你们中的一些人可能已经注意到了，噩梦追逐者的灯光与现实世界中的灯光并不一致。Unity 的优秀人员再一次为我们提供了解决方案(声明一下，我与 Unity 没有任何关系；我确实认为他们在 Unity ARKit 上做得很好。

#### 关灯

我们将为我们的应用程序使用不同的光源。然而，为了获得最佳效果，让我们确保已经关闭了场景中的所有灯光。

从主菜单中选择窗口➤照明➤设置(图 [4-25](#Fig25) )。

![img/460089_1_En_4_Chapter/460089_1_En_4_Fig25_HTML.jpg](img/460089_1_En_4_Chapter/460089_1_En_4_Fig25_HTML.jpg)

图 4-25

选择照明设置

在照明设置中，在环境设置中将强度乘数更改为零。在混合照明设置中，取消烘焙照明设置(图 [4-26](#Fig26) )。

![img/460089_1_En_4_Chapter/460089_1_En_4_Fig26_HTML.jpg](img/460089_1_En_4_Chapter/460089_1_En_4_Fig26_HTML.jpg)

图 4-26

更改照明设置

现在选择平行光，在检查器中，改变颜色为白色。有许多方法可以改变颜色。首先在检查器中，选择颜色属性框，颜色选择器将会出现(图 [4-27](#Fig27) )。在颜色选择器菜单中，有一个颜色选择器滚轮用于选择颜色。要使用此滚轮，请选择并拖动小颜色选择圆，直到找到您想要的颜色。在圆圈的中心，有一个正方形用于选择音调。一旦你选择了一个接近你想要的颜色，然后你可以使用正方形中的小圆圈来完善你的选择。这种方法可能适用于某些人，但我只需在属性框中输入我想要的颜色的 RGB 或 HSV 值(图 [4-28](#Fig28) )。

![img/460089_1_En_4_Chapter/460089_1_En_4_Fig28_HTML.jpg](img/460089_1_En_4_Chapter/460089_1_En_4_Fig28_HTML.jpg)

图 4-28

键入颜色属性

![img/460089_1_En_4_Chapter/460089_1_En_4_Fig27_HTML.jpg](img/460089_1_En_4_Chapter/460089_1_En_4_Fig27_HTML.jpg)

图 4-27

使用色轮

#### 设置环境光源

现在我们可以设置环境光源。选择方向灯，选择添加组件按钮并搜索环境(图 [4-29](#Fig29) )。

![img/460089_1_En_4_Chapter/460089_1_En_4_Fig29_HTML.jpg](img/460089_1_En_4_Chapter/460089_1_En_4_Fig29_HTML.jpg)

图 4-29

搜索 Unity AR 环境组件

你会看到 Unity ARKit 还包含了一个名为 Unity AR Ambient 的脚本。选择这个脚本将其添加到我们的平行光中(图 [4-30](#Fig30) )。

![img/460089_1_En_4_Chapter/460089_1_En_4_Fig30_HTML.jpg](img/460089_1_En_4_Chapter/460089_1_En_4_Fig30_HTML.jpg)

图 4-30

添加到平行光的 Unity AR 环境脚本

这个脚本估计了真实世界的照明，并将在我们的应用程序中对照明进行更改。这将使我们的应用程序看起来更真实。现在让我们在不同的光照条件下测试这个应用程序。现在，您应该已经知道如何构建和运行场景了。在我们这样做之前，我建议在播放器设置中做一个小小的改变。

#### 构建和运行–版本控制

我是版本控制的超级粉丝。我认为在进行任何重大或微小的更改时，用不同的版本号保存我们的工作是一个好的做法。其实在写这本书的时候，我已经使用了版本控制。我有太多的系统崩溃的例子，无法恢复我正在工作的项目的最后版本。幸运的是，大多数时候，我有一个先前的版本可以使用，并且可以相对快速地恢复工作。

因为我们已经有了 Hello WorldAR Hit 测试的早期版本，所以我将用不同的版本号保存下一个测试。从主菜单中选择构建设置，然后选择播放器设置(图 [4-31](#Fig31) )。在播放器设置的检查器中，向下滚动以查看识别设置，并在版本下将版本更改为 2.0。有些人可能认为版本应该是 1.1(因为这只是一个微小的变化)，但是只要我们改变了版本号，那就是最重要的。

![img/460089_1_En_4_Chapter/460089_1_En_4_Fig31_HTML.jpg](img/460089_1_En_4_Chapter/460089_1_En_4_Fig31_HTML.jpg)

图 4-31

在检查器视图中更改版本标识

现在打开 Xcode，确保您已经登录，将您的 iOS 设备连接到 Mac，然后选择“构建并运行”。如果你的构建是成功的，你应该注意到在不同的光照条件下，应用程序中的光照会发生变化。

### 定位摄像机

你可能已经发现，即使我们小心地将我们的噩梦追逐者放置在面对玩家摄像头的位置，当我们在设备上运行应用程序时，他并不总是面对摄像头。噩梦追逐者的位置将取决于当你启动应用程序时你的 iOS 设备正对着哪里。虽然这是一本面向初学者的书，但我们将不得不编写一些代码。希望这对你来说不会太痛苦。这段代码将自动旋转我们的噩梦追逐者，使其在每次启动应用程序时都面对摄像机。

#### 编辑 Unity AR 点击测试脚本

在层次结构中，选择创建的平面游戏对象；在检查员那里。在“脚本属性”框中选择 UnityARHitTestExample。这应该会在项目文件夹中找到并突出显示 UnityARHitTestExample.cs 脚本(图 [4-32](#Fig32) )。

![img/460089_1_En_4_Chapter/460089_1_En_4_Fig32_HTML.jpg](img/460089_1_En_4_Chapter/460089_1_En_4_Fig32_HTML.jpg)

图 4-32

选择 UnityARHitTestExample.cs 脚本

如果你没有 Visual Studio 或 Mono developer 的副本，我强烈建议你下载一份并立即安装。虽然我们不会在整本书中写很多代码，但是如果你真的想为 iOS 开发 AR 游戏，那么你需要一个 IDE。

选中 UnityARHitTestExample.cs 脚本后，双击该文件，它应该会在您的 IDE (Visual Studio 或 MonoDevelop)中打开。在第 18 行，输入以下代码:

```cs
//Automatically Face the Camera
m_HitTransform.LookAt (Camera.main.transform.position);
m_HitTransform.eulerAngles = new Vector3 (0, m_HitTransform.eulerAngles.y, 0);

```

现在保存脚本并测试它，看看它是否能运行。//向代码添加注释，编译时会被忽略。如果您遇到任何运行时错误或代码 bug，只需注释掉这三行代码，它应该会运行(尽管，我们的梦魇追逐者不会自动定位，使其面向摄像机)。

### 摘要

在这一章中，我们学习了点击测试，这有助于我们的应用程序识别现实世界中的表面，并将游戏对象“放置”在这些表面上。我们还学习了如何改变灯光，使其与现实世界中的灯光一致。